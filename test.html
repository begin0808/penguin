<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ä¼éµåœè»Šé›·é”</title>
    
    <!-- Tailwind CSS (CDN ç”¨æ–¼å¿«é€Ÿé è¦½ï¼Œæœ¬æ©Ÿé–‹ç™¼å»ºè­°æ”¹ç”¨ npm å®‰è£) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Font Awesome (ä¿ç•™ä½œç‚ºå‚™ç”¨) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* åŸºç¤è¨­å®šèˆ‡å­—å‹ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a; /* Slate-900 */
            color: white;
            overflow: hidden; /* é˜²æ­¢æ•´é«”é é¢æ²å‹• */
        }

        /* ç»ç’ƒæ“¬æ…‹ */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(56, 189, 248, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* éœ“è™¹ç™¼å…‰æ•ˆæœ */
        .neon-text {
            text-shadow: 0 0 5px rgba(14, 165, 233, 0.8), 0 0 10px rgba(14, 165, 233, 0.5);
        }
        
        .neon-border {
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
        }

        /* åœ°åœ–å®¹å™¨ */
        #map-container {
            height: 100vh;
            width: 100vw;
            z-index: 0;
            background: #0f172a;
        }

        /* è‡ªå®šç¾© Leaflet Popup */
        .custom-popup .leaflet-popup-content-wrapper {
            background: rgba(15, 23, 42, 0.9);
            color: white;
            border: 1px solid #0ea5e9;
            backdrop-filter: blur(4px);
            border-radius: 12px;
        }
        .custom-popup .leaflet-popup-tip {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid #0ea5e9;
        }
        .custom-popup .leaflet-popup-close-button {
            color: #0ea5e9;
        }

        /* é›·é”æƒæå‹•ç•« */
        @keyframes radar-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .radar-scan {
            animation: radar-spin 4s linear infinite;
            transform-origin: center;
        }
        
        /* ä½¿ç”¨è€…ä½ç½®è„ˆè¡ */
        .user-pulse {
            width: 20px;
            height: 20px;
            background: #ff4d4d;
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 0 rgba(255, 77, 77, 0.4);
            animation: user-pulse 2s infinite;
        }
        .user-pulse::after {
            content: '';
            position: absolute;
            left: -10px;
            top: -10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ff4d4d;
            animation: pulse-ring 2s infinite;
        }

        @keyframes user-pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 77, 77, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); }
        }

        /* éš±è— Scrollbar ä½†å¯æ²å‹• */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Marker CSS Classes (Leaflet DivIcon) */
        .marker-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        .marker-green { background-color: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .marker-yellow { background-color: #eab308; box-shadow: 0 0 10px #eab308; }
        .marker-red { background-color: #ef4444; box-shadow: 0 0 10px #ef4444; }
        .marker-grey { background-color: #94a3b8; width: 10px; height: 10px; opacity: 0.8; } /* æœªçŸ¥ç‹€æ…‹è¼ƒå° */

    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // è¨­å®šå€åŸŸ (è«‹å¡«å…¥ä½ çš„ GAS Web App URL)
        // ==========================================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycby6jEHc0kSPE58EJPs9dqZkATVu2srXh6gi1ElIrH1RuS7veEVBMSHFuH-jZEYqwlpK/exec";
        
        const SEARCH_RADIUS_KM = 3;
        const AUTO_REFRESH_INTERVAL = 60000; // 60ç§’

        // æ”¯æ´å³æ™‚å‹•æ…‹çš„ç¸£å¸‚ (ç”¨æ–¼ä»‹é¢é¡¯ç¤ºæˆ–éæ¿¾)
        const CITIES = [
            { id: 'Keelung', name: 'åŸºéš†å¸‚', type: 'dynamic' },
            { id: 'Taipei', name: 'å°åŒ—å¸‚', type: 'dynamic' },
            { id: 'NewTaipei', name: 'æ–°åŒ—å¸‚', type: 'dynamic' },
            { id: 'Taoyuan', name: 'æ¡ƒåœ’å¸‚', type: 'dynamic' },
            { id: 'Hsinchu', name: 'æ–°ç«¹å¸‚', type: 'dynamic' },
            { id: 'HsinchuCounty', name: 'æ–°ç«¹ç¸£', type: 'dynamic' },
            { id: 'Taichung', name: 'å°ä¸­å¸‚', type: 'dynamic' },
            { id: 'Tainan', name: 'å°å—å¸‚', type: 'dynamic' },
            { id: 'Kaohsiung', name: 'é«˜é›„å¸‚', type: 'dynamic' },
            { id: 'YilanCounty', name: 'å®œè˜­ç¸£', type: 'dynamic' },
            { id: 'Chiayi', name: 'å˜‰ç¾©å¸‚', type: 'static' },
            { id: 'HualienCounty', name: 'èŠ±è“®ç¸£', type: 'static' },
            { id: 'TaitungCounty', name: 'å°æ±ç¸£', type: 'static' },
            // å…¶ä»–å¯ä¾éœ€æ±‚åŠ å…¥
        ];

        const { useState, useEffect, useRef, useMemo } = React;
        
        // ==========================================
        // Icon Components (Replacements for Lucide)
        // ==========================================
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Navigation = (props) => (
            <IconBase {...props}><polygon points="3 11 22 2 13 21 11 13 3 11"/></IconBase>
        );
        const RefreshCw = (props) => (
            <IconBase {...props}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconBase>
        );
        const List = (props) => (
            <IconBase {...props}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconBase>
        );
        const MapIcon = (props) => (
            <IconBase {...props}><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></IconBase>
        );
        const Info = (props) => (
            <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></IconBase>
        );
        const Volume2 = (props) => (
            <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></IconBase>
        );
        const Search = (props) => (
            <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>
        );
        const X = (props) => (
            <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>
        );

        // ä¼éµ Logo å…ƒä»¶
        const PenguinLogo = () => (
            <svg width="40" height="40" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" className="mr-2">
                {/* é›·é”åœˆ */}
                <circle cx="50" cy="50" r="45" stroke="#0ea5e9" strokeWidth="2" strokeDasharray="10 5" opacity="0.5" className="radar-scan" />
                <circle cx="50" cy="50" r="35" stroke="#0ea5e9" strokeWidth="1" opacity="0.3" />
                
                {/* ä¼éµèº«é«” (ç°¡åŒ–ç‰ˆ) */}
                <path d="M50 20C40 20 32 28 32 40V70C32 78 38 85 50 85C62 85 68 78 68 70V40C68 28 60 20 50 20Z" fill="#e2e8f0" />
                <path d="M50 20C40 20 32 28 32 40V70C32 78 35 85 50 85" fill="#334155" /> 
                <path d="M30 50L20 55" stroke="#fcd34d" strokeWidth="3" strokeLinecap="round"/> {/* å·¦ç¿…è†€ */}
                <path d="M70 50L80 55" stroke="#fcd34d" strokeWidth="3" strokeLinecap="round"/> {/* å³ç¿…è†€ */}
                <circle cx="45" cy="35" r="2" fill="#0f172a" />
                <circle cx="55" cy="35" r="2" fill="#0f172a" />
                <path d="M48 40L50 42L52 40" stroke="#f59e0b" strokeWidth="2" /> {/* å˜´å·´ */}
                <path d="M40 85L35 90" stroke="#fcd34d" strokeWidth="3" strokeLinecap="round"/> {/* å·¦è…³ */}
                <path d="M60 85L65 90" stroke="#fcd34d" strokeWidth="3" strokeLinecap="round"/> {/* å³è…³ */}
            </svg>
        );

        // æ¨¡æ“¬è³‡æ–™ç”Ÿæˆå™¨ (ç•¶æ²’æœ‰ GAS URL æ™‚ä½¿ç”¨)
        const generateMockData = (centerLat, centerLng) => {
            const mocks = [];
            for (let i = 0; i < 20; i++) {
                const lat = centerLat + (Math.random() - 0.5) * 0.04;
                const lng = centerLng + (Math.random() - 0.5) * 0.04;
                const total = Math.floor(Math.random() * 200) + 20;
                // æ¨¡æ“¬ä¸‰ç¨®ç‹€æ…‹ + æœªçŸ¥
                const rand = Math.random();
                let available;
                if(rand > 0.8) available = -1; // æœªçŸ¥
                else available = Math.floor(Math.random() * total);

                mocks.push({
                    id: `mock-${i}`,
                    name: `æ¸¬è©¦åœè»Šå ´ ${i+1}è™Ÿ`,
                    lat, lng,
                    total,
                    available,
                    fare: 'æ¯å°æ™‚ 30 å…ƒï¼Œç•¶æ—¥æœ€é«˜ 150 å…ƒ',
                    city: 'MockCity',
                    address: 'æ¸¬è©¦åœ°å€è·¯æ®µ100è™Ÿ'
                });
            }
            return mocks;
        };

        const App = () => {
            const [viewMode, setViewMode] = useState('map'); // 'map' or 'list' (æ¨è–¦æ¨¡å¼)
            const [userLocation, setUserLocation] = useState(null);
            const [parkings, setParkings] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedCity, setSelectedCity] = useState(CITIES[1].id); // é è¨­å°åŒ—
            const [lastUpdated, setLastUpdated] = useState(null);
            const [showInstruction, setShowInstruction] = useState(true);
            const [locationStatus, setLocationStatus] = useState('å®šä½ä¸­...');

            const mapRef = useRef(null);
            const markerLayerRef = useRef(null);

            // 1. åˆå§‹åŒ–å®šä½ (å·²ä¿®æ­£éŒ¯èª¤è™•ç†èˆ‡Timeout)
            useEffect(() => {
                const handleSuccess = (position) => {
                    const { latitude, longitude } = position.coords;
                    setUserLocation({ lat: latitude, lng: longitude });
                    loadData(latitude, longitude, selectedCity);
                    setLocationStatus('ç³»çµ±é‹ä½œæ­£å¸¸');
                };

                const handleError = (error) => {
                    let msg = error.message || 'æœªçŸ¥åŸå› ';
                    console.warn(`å®šä½å¤±æ•— (${msg})ï¼Œåˆ‡æ›è‡³é è¨­ä½ç½®(å°åŒ—è»Šç«™)`);
                    
                    // é è¨­ä½ç½®: å°åŒ—è»Šç«™
                    const defLat = 25.0478;
                    const defLng = 121.5170;
                    setUserLocation({ lat: defLat, lng: defLng });
                    loadData(defLat, defLng, selectedCity);
                    setLocationStatus('å®šä½å¤±æ•—ï¼Œä½¿ç”¨é è¨­ä½ç½®');
                };

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        handleSuccess,
                        handleError,
                        { timeout: 8000, enableHighAccuracy: false, maximumAge: 0 }
                    );
                } else {
                    handleError({ message: "ç€è¦½å™¨ä¸æ”¯æ´" });
                }
            }, []);

            // 2. å®šæ™‚æ›´æ–° (Silent Refresh)
            useEffect(() => {
                const interval = setInterval(() => {
                    if (userLocation) {
                        console.log("Auto refreshing data...");
                        loadData(userLocation.lat, userLocation.lng, selectedCity, true);
                    }
                }, AUTO_REFRESH_INTERVAL);
                return () => clearInterval(interval);
            }, [userLocation, selectedCity]);

            // 3. è¼‰å…¥è³‡æ–™é‚è¼¯
            const loadData = async (lat, lng, city, isSilent = false) => {
                if (!isSilent) setLoading(true);

                try {
                    let data = [];
                    if (GAS_API_URL) {
                        const url = `${GAS_API_URL}?lat=${lat}&lng=${lng}&radius=${SEARCH_RADIUS_KM * 1000}&city=${city}`;
                        const res = await fetch(url);
                        const json = await res.json();
                        if (json.status === 'success') {
                            data = json.data;
                        }
                    } else {
                        // ä½¿ç”¨ Mock Data
                        console.log("Using Mock Data");
                        await new Promise(r => setTimeout(r, 800)); // æ¨¡æ“¬å»¶é²
                        data = generateMockData(lat, lng);
                    }
                    
                    // æ ¹æ“šè·é›¢æ’åº
                    data.forEach(p => {
                        p.distance = getDistanceFromLatLonInKm(lat, lng, p.lat, p.lng);
                    });
                    data.sort((a, b) => a.distance - b.distance);

                    setParkings(data);
                    setLastUpdated(new Date());
                    
                    // æ›´æ–°åœ°åœ–æ¨™è¨˜ (å¦‚æœæ˜¯ Map æ¨¡å¼)
                    if (mapRef.current) {
                        updateMapMarkers(data);
                    }

                } catch (error) {
                    console.error("Fetch data error:", error);
                } finally {
                    setLoading(false);
                }
            };

            // è¨ˆç®—è·é›¢å…¬å¼
            const getDistanceFromLatLonInKm = (lat1, lon1, lat2, lon2) => {
                const R = 6371; 
                const dLat = deg2rad(lat2-lat1); 
                const dLon = deg2rad(lon2-lon1); 
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                const d = R * c; 
                return d;
            }
            const deg2rad = (deg) => deg * (Math.PI/180);

            // 4. åˆå§‹åŒ– Leaflet åœ°åœ–
            useEffect(() => {
                if (!mapRef.current && userLocation) {
                    // å»ºç«‹åœ°åœ–
                    mapRef.current = L.map('map-container', {
                        zoomControl: false,
                        attributionControl: false
                    }).setView([userLocation.lat, userLocation.lng], 15);

                    // æ·±è‰²åº•åœ– (CartoDB Dark Matter)
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        maxZoom: 19
                    }).addTo(mapRef.current);

                    // ä½¿ç”¨è€…ä½ç½®æ¨™è¨˜
                    const userIcon = L.divIcon({
                        className: 'user-marker-container',
                        html: '<div class="user-pulse"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(mapRef.current);
                    
                    // æ¨™è¨˜åœ–å±¤ç¾¤çµ„
                    markerLayerRef.current = L.layerGroup().addTo(mapRef.current);
                    
                    // åˆæ¬¡åŠ å…¥æ¨™è¨˜
                    if (parkings.length > 0) {
                        updateMapMarkers(parkings);
                    }
                } else if (mapRef.current && userLocation) {
                    // è‹¥ä½ç½®æ”¹è®Šï¼Œç§»å‹•è¦–è§’ (éå¿…è¦ï¼Œè¦– UX æ±ºå®š)
                    // mapRef.current.panTo([userLocation.lat, userLocation.lng]);
                }
            }, [userLocation]);

            // 5. æ›´æ–°åœ°åœ–æ¨™è¨˜é‚è¼¯ (Silent Refresh æ ¸å¿ƒ)
            const updateMapMarkers = (data) => {
                if (!markerLayerRef.current) return;
                
                markerLayerRef.current.clearLayers();

                data.forEach(p => {
                    // åˆ¤æ–·é¡è‰²
                    let colorClass = 'marker-grey';
                    let statusText = 'æœªçŸ¥';
                    
                    if (p.available !== -1) {
                        const ratio = p.total > 0 ? (p.available / p.total) : 0;
                        if (p.available === 0 || ratio < 0.1) {
                            colorClass = 'marker-red';
                            statusText = 'æ»¿ä½';
                        } else if (ratio < 0.3) {
                            colorClass = 'marker-yellow';
                            statusText = 'ç·Šå¼µ';
                        } else {
                            colorClass = 'marker-green';
                            statusText = 'å……è£•';
                        }
                    }

                    const icon = L.divIcon({
                        className: `custom-div-icon`,
                        html: `<div class="marker-dot ${colorClass}"></div>`,
                        iconSize: [14, 14],
                        iconAnchor: [7, 7]
                    });

                    const marker = L.marker([p.lat, p.lng], { icon: icon })
                        .bindPopup(`
                            <div class="font-sans min-w-[200px]">
                                <h3 class="font-bold text-sky-400 text-lg mb-1">${p.name}</h3>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-300 text-sm">å‰©é¤˜è»Šä½</span>
                                    <span class="text-2xl font-bold ${colorClass.replace('marker-', 'text-')}">
                                        ${p.available === -1 ? '?' : p.available}
                                    </span>
                                </div>
                                <div class="text-xs text-gray-400 mb-2">${p.fare}</div>
                                <button onclick="window.triggerNav('${p.name}', ${p.lat}, ${p.lng})" 
                                    class="w-full bg-sky-600 hover:bg-sky-500 text-white text-sm py-1 px-3 rounded-full flex items-center justify-center gap-2 transition">
                                    <i class="fas fa-location-arrow"></i> å°èˆª
                                </button>
                            </div>
                        `, { className: 'custom-popup' });
                    
                    marker.addTo(markerLayerRef.current);
                });
            };

            // å…¨åŸŸå°èˆªè§¸ç™¼ (çµ¦ Popup ç”¨)
            useEffect(() => {
                window.triggerNav = (name, lat, lng) => {
                    handleNavigation(name, lat, lng);
                };
            }, []);

            // 6. èªéŸ³å°èˆª
            const handleNavigation = (name, lat, lng) => {
                // èªéŸ³æ’­å ±
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(`æ­£åœ¨ç‚ºæ‚¨å°èˆªè‡³ ${name}`);
                    utterance.lang = 'zh-TW';
                    utterance.rate = 1.2;
                    window.speechSynthesis.speak(utterance);
                }

                // é–‹å•Ÿ Google Maps
                setTimeout(() => {
                    window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
                }, 1500);
            };

            // ä»‹é¢æ¸²æŸ“
            return (
                <div className="relative w-full h-full">
                    {/* èƒŒæ™¯åœ°åœ– */}
                    <div id="map-container" className={viewMode === 'list' ? 'hidden' : 'block'}></div>
                    
                    {/* æ¨è–¦åˆ—è¡¨æ¨¡å¼èƒŒæ™¯ (å¦‚æœåˆ‡æ›åˆ°åˆ—è¡¨) */}
                    {viewMode === 'list' && (
                        <div className="absolute inset-0 bg-slate-900 overflow-y-auto pb-32">
                             <div className="p-4 pt-24 max-w-md mx-auto space-y-4">
                                {parkings.map((p) => {
                                    let statusColor = p.available === -1 ? 'text-gray-400' : 
                                        (p.available === 0 || p.available/p.total < 0.1) ? 'text-red-500' :
                                        (p.available/p.total < 0.3) ? 'text-yellow-500' : 'text-green-500';
                                    
                                    return (
                                        <div key={p.id} className="glass-panel p-4 rounded-xl border-l-4 border-sky-500">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <h3 className="text-lg font-bold text-white">{p.name}</h3>
                                                    <p className="text-xs text-gray-400 mt-1">{p.distance.toFixed(1)} km | {p.city}</p>
                                                </div>
                                                <div className="text-right">
                                                    <div className={`text-2xl font-bold ${statusColor}`}>
                                                        {p.available === -1 ? '?' : p.available}
                                                        <span className="text-xs text-gray-500 block">å‰©é¤˜</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <p className="text-xs text-gray-300 mt-2 line-clamp-1">{p.fare}</p>
                                            <button 
                                                onClick={() => handleNavigation(p.name, p.lat, p.lng)}
                                                className="mt-3 w-full bg-sky-600/50 hover:bg-sky-500/50 border border-sky-500/30 text-sky-100 py-2 rounded-lg text-sm flex items-center justify-center gap-2"
                                            >
                                                <Navigation size={14} /> ç«‹å³å‰å¾€
                                            </button>
                                        </div>
                                    )
                                })}
                                {parkings.length === 0 && !loading && (
                                    <div className="text-center text-gray-500 mt-10">é™„è¿‘ 3 å…¬é‡Œå…§ç„¡è³‡æ–™</div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* é ‚éƒ¨å°è¦½åˆ— (Top Bar) */}
                    <div className="absolute top-0 left-0 right-0 z-[500] p-4">
                        <div className="glass-panel rounded-2xl p-3 flex justify-between items-center neon-border">
                            <div className="flex items-center">
                                <PenguinLogo />
                                <div>
                                    <h1 className="text-lg font-bold text-white neon-text">å°ä¼éµé›·é”</h1>
                                    <div className="text-[10px] text-sky-300 flex items-center gap-1">
                                        {loading ? <RefreshCw size={10} className="animate-spin"/> : <div className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>}
                                        {loading ? 'æƒæä¸­...' : locationStatus}
                                    </div>
                                </div>
                            </div>
                            
                            <button 
                                onClick={() => setShowInstruction(true)}
                                className="p-2 rounded-full bg-slate-800/50 text-sky-400 hover:bg-slate-700/50"
                            >
                                <Info size={20} />
                            </button>
                        </div>
                    </div>

                    {/* åº•éƒ¨æ§åˆ¶é¢æ¿ (Bottom Controls) */}
                    <div className="absolute bottom-6 left-4 right-4 z-[500] flex flex-col gap-3 max-w-md mx-auto">
                        
                        {/* åŸå¸‚é¸æ“‡å™¨ & æ›´æ–°æ™‚é–“ */}
                        <div className="flex justify-between items-end">
                             <div className="glass-panel rounded-lg px-3 py-1 text-[10px] text-gray-400">
                                ä¸Šæ¬¡æ›´æ–°: {lastUpdated ? lastUpdated.toLocaleTimeString() : '--:--'}
                            </div>
                            
                            {/* åœ°åœ–ç¸®æ”¾æ§åˆ¶ (åƒ…åœ¨ Map æ¨¡å¼é¡¯ç¤º) */}
                            {viewMode === 'map' && mapRef.current && (
                                <div className="flex flex-col gap-1">
                                    <button onClick={() => mapRef.current.zoomIn()} className="w-10 h-10 glass-panel rounded-full flex items-center justify-center text-white text-xl">+</button>
                                    <button onClick={() => mapRef.current.zoomOut()} className="w-10 h-10 glass-panel rounded-full flex items-center justify-center text-white text-xl">-</button>
                                </div>
                            )}
                        </div>

                        {/* ä¸»æ§åˆ¶åˆ— */}
                        <div className="glass-panel rounded-2xl p-2 grid grid-cols-4 gap-2 neon-border">
                            
                            {/* åŸå¸‚é¸å–® */}
                            <div className="col-span-2 relative">
                                <select 
                                    value={selectedCity}
                                    onChange={(e) => {
                                        setSelectedCity(e.target.value);
                                        // å¦‚æœæœ‰ä½ç½®ï¼Œé‡æ–°è¼‰å…¥
                                        if (userLocation) loadData(userLocation.lat, userLocation.lng, e.target.value);
                                    }}
                                    className="w-full h-full bg-slate-800/50 text-white text-sm rounded-xl pl-8 pr-2 appearance-none outline-none border border-slate-600 focus:border-sky-500"
                                >
                                    {CITIES.map(c => (
                                        <option key={c.id} value={c.id}>
                                            {c.name} {c.type === 'dynamic' ? 'ğŸŸ¢' : 'âšª'}
                                        </option>
                                    ))}
                                </select>
                                <Search className="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400" size={14} />
                            </div>

                            {/* æª¢è¦–æ¨¡å¼åˆ‡æ› */}
                            <button 
                                onClick={() => setViewMode('map')}
                                className={`flex flex-col items-center justify-center py-2 rounded-xl transition ${viewMode === 'map' ? 'bg-sky-600 text-white shadow-lg shadow-sky-900/50' : 'text-gray-400 hover:text-white'}`}
                            >
                                <MapIcon size={18} />
                                <span className="text-[10px] mt-1">é›·é”</span>
                            </button>

                            <button 
                                onClick={() => setViewMode('list')}
                                className={`flex flex-col items-center justify-center py-2 rounded-xl transition ${viewMode === 'list' ? 'bg-sky-600 text-white shadow-lg shadow-sky-900/50' : 'text-gray-400 hover:text-white'}`}
                            >
                                <List size={18} />
                                <span className="text-[10px] mt-1">æ¨è–¦</span>
                            </button>
                        </div>
                    </div>

                    {/* èªªæ˜ Modal */}
                    {showInstruction && (
                        <div className="fixed inset-0 z-[1000] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm">
                            <div className="glass-panel max-w-sm w-full rounded-2xl p-6 border border-sky-500/30 shadow-2xl relative">
                                <button onClick={() => setShowInstruction(false)} className="absolute top-4 right-4 text-gray-400 hover:text-white">
                                    <X size={20} />
                                </button>
                                
                                <div className="text-center mb-4">
                                    <PenguinLogo />
                                    <h2 className="text-xl font-bold text-white mt-2 neon-text">æ­¡è¿ä½¿ç”¨å°ä¼éµé›·é”</h2>
                                </div>

                                <div className="space-y-3 text-sm text-gray-300">
                                    <div className="flex items-start gap-3">
                                        <div className="w-2 h-2 mt-1.5 rounded-full bg-red-500 shadow-[0_0_8px_#ef4444]"></div>
                                        <p><span className="text-white font-bold">ç´…è‰²æ³¢ç´‹</span> ç‚ºæ‚¨çš„ç›®å‰ä½ç½®ã€‚</p>
                                    </div>
                                    <div className="flex items-start gap-3">
                                        <div className="w-2 h-2 mt-1.5 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]"></div>
                                        <p>ç¶ é»ä»£è¡¨è»Šä½å……è£• (>30%)ã€‚</p>
                                    </div>
                                    <div className="flex items-start gap-3">
                                        <div className="w-2 h-2 mt-1.5 rounded-full bg-yellow-500 shadow-[0_0_8px_#eab308]"></div>
                                        <p>é»ƒé»ä»£è¡¨è»Šä½ç·Šå¼µ (&lt;30%)ã€‚</p>
                                    </div>
                                    <div className="flex items-start gap-3">
                                        <div className="w-2 h-2 mt-1.5 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]"></div>
                                        <p>ç¶ é»ä»£è¡¨è»Šä½å……è£• (>30%)ã€‚</p>
                                    </div>
                                    <div className="flex items-start gap-3">
                                        <div className="w-2 h-2 mt-1.5 rounded-full bg-yellow-500 shadow-[0_0_8px_#eab308]"></div>
                                        <p>é»ƒé»ä»£è¡¨è»Šä½ç·Šå¼µ (&lt;30%)ã€‚</p>
                                    </div>
                                    <div className="flex items-start gap-3">
                                        <Volume2 size={14} className="mt-0.5 text-sky-400" />
                                        <p>é»æ“Šã€Œå°èˆªã€æŒ‰éˆ•å°‡æ’­æ”¾èªéŸ³ç¢ºèªï¼Œä¸¦é–‹å•Ÿåœ°åœ–ã€‚</p>
                                    </div>
                                </div>

                                <button 
                                    onClick={() => setShowInstruction(false)}
                                    className="mt-6 w-full bg-sky-600 hover:bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-900/20 transition"
                                >
                                    é–‹å§‹æƒæ
                                </button>
                                
                                <p className="text-[10px] text-center text-gray-500 mt-4">
                                    ç›®å‰è³‡æ–™ä¾†æº: TDX äº¤é€šè³‡æ–™æµé€šæœå‹™
                                    <br/>
                                    {GAS_API_URL ? 'å·²é€£æ¥å¾Œç«¯ API' : 'ç›®å‰ç‚ºé è¦½æ¨¡å¼ (æ¨¡æ“¬è³‡æ–™)'}
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>